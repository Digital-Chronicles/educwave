{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">
          {{ student.first_name }} {{ student.last_name }} – Finance
        </h1>
        <p class="mt-1 text-sm text-gray-500">
          Grade: {{ student.current_grade }} |
          Registration ID:
          {% if student.registration_id %}
            {{ student.registration_id }}
          {% else %}
            <span class="italic text-gray-400">N/A</span>
          {% endif %}
        </p>
      </div>
      <div class="flex space-x-2">
        <a href="{% url 'finance_student_list' %}"
           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md
                  text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2
                  focus:ring-offset-2 focus:ring-indigo-500">
          Back to Students
        </a>
        <a href="{% url 'finance-dashboard' %}"
           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm
                  text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2
                  focus:ring-offset-2 focus:ring-indigo-500">
          Dashboard
        </a>
      </div>
    </div>

    <!-- Messages -->
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for message in messages %}
          <div class="rounded-md p-3 text-sm
                      {% if message.tags == 'success' %}
                        bg-green-50 text-green-800 border border-green-200
                      {% elif message.tags == 'error' %}
                        bg-red-50 text-red-800 border border-red-200
                      {% else %}
                        bg-blue-50 text-blue-800 border border-blue-200
                      {% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Summary cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-5 mb-8">
      <div class="bg-white rounded-lg shadow p-5">
        <dt class="text-sm font-medium text-gray-500 truncate">Total Fee</dt>
        <dd class="mt-2 text-2xl font-semibold text-gray-900">
          {{ total_fee|default:"0.00" }}
        </dd>
      </div>

      <div class="bg-white rounded-lg shadow p-5">
        <dt class="text-sm font-medium text-gray-500 truncate">Total Paid</dt>
        <dd class="mt-2 text-2xl font-semibold text-green-600">
          {{ total_paid|default:"0.00" }}
        </dd>
      </div>

      <div class="bg-white rounded-lg shadow p-5">
        <dt class="text-sm font-medium text-gray-500 truncate">Balance</dt>
        <dd class="mt-2 text-2xl font-semibold {% if balance > 0 %}text-red-600{% else %}text-gray-900{% endif %}">
          {{ balance|default:"0.00" }}
        </dd>
      </div>
    </div>

    <!-- Tuition description + actions -->
    <div class="bg-white shadow rounded-lg mb-8">
      <div class="px-4 py-4 sm:px-6 flex items-center justify-between border-b border-gray-200">
        <div>
          <h2 class="text-lg leading-6 font-medium text-gray-900">
            Tuition Description
          </h2>
          <p class="mt-1 text-sm text-gray-500">
            Fee structure attached to this student based on their grade.
          </p>
        </div>
        <div class="flex space-x-2">
          <a href="{% url 'register_student_tuition_description' student.id %}"
             class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md
                    shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2
                    focus:ring-offset-2 focus:ring-indigo-500">
            {% if tuition_desc %}
              Edit Tuition Description
            {% else %}
              Set Tuition Description
            {% endif %}
          </a>
          {% if tuition_desc %}
            <a href="{% url 'record_fee_payment' student.id %}"
               class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md
                      shadow-sm text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2
                      focus:ring-offset-2 focus:ring-emerald-500">
              Record Payment
            </a>
          {% endif %}
        </div>
      </div>

      <div class="px-4 py-5 sm:px-6">
        {% if tuition_desc %}
          <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Grade</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {{ tuition_desc.tuition.grade.grade_name }}
              </dd>
            </div>

            <div>
              <dt class="text-sm font-medium text-gray-500">Base Tuition</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {{ tuition_desc.tuition.tuitionfee }}
              </dd>
            </div>

            <div>
              <dt class="text-sm font-medium text-gray-500">Hostel</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {% if tuition_desc.hostel %}
                  Yes ({{ tuition_desc.tuition.hostelfee }})
                {% else %}
                  No
                {% endif %}
              </dd>
            </div>

            <div>
              <dt class="text-sm font-medium text-gray-500">Lunch</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {% if tuition_desc.lunch %}
                  Yes ({{ tuition_desc.tuition.lunchfee }})
                {% else %}
                  No
                {% endif %}
              </dd>
            </div>

            <div>
              <dt class="text-sm font-medium text-gray-500">Breakfast</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {% if tuition_desc.breakfast %}
                  Yes ({{ tuition_desc.tuition.breakfastfee }})
                {% else %}
                  No
                {% endif %}
              </dd>
            </div>

            <div>
              <dt class="text-sm font-medium text-gray-500">Total Fee (calculated)</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {{ total_fee|default:tuition_desc.total_fee }}
              </dd>
            </div>
          </dl>
        {% else %}
          <p class="text-sm text-gray-500">
            No tuition description has been set for this student yet.
            Click <span class="font-semibold">“Set Tuition Description”</span> above to configure it.
          </p>
        {% endif %}
      </div>
    </div>

    <!-- Payments table -->
    {% if tuition_desc %}
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-4 sm:px-6 border-b border-gray-200 flex items-center justify-between">
          <h2 class="text-lg leading-6 font-medium text-gray-900">
            Payments
          </h2>
          <p class="text-sm text-gray-500">
            All recorded fee transactions for this student.
          </p>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Date
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Term / Year
                </th>
                <th scope="col"
                    class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Amount Paid
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Method
                </th>
                <th scope="col"
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Status
                </th>
                <th scope="col"
                    class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Balance After
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for t in transactions %}
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm text-gray-900">
                    {{ t.created }}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-700">
                    {% if t.term %}{{ t.get_term_display }}{% else %}-{% endif %}
                    {% if t.academic_year %} / {{ t.academic_year }}{% endif %}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900 text-right">
                    {{ t.amount_paid }}
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-700">
                    {{ t.get_payment_method_display }}
                  </td>
                  <td class="px-4 py-3 text-sm">
                    {% if t.status == 'paid' %}
                      <span class="inline-flex px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                        Paid
                      </span>
                    {% elif t.status == 'partial' %}
                      <span class="inline-flex px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">
                        Partial
                      </span>
                    {% elif t.status == 'overdue' %}
                      <span class="inline-flex px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                        Overdue
                      </span>
                    {% else %}
                      <span class="inline-flex px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700">
                        Pending
                      </span>
                    {% endif %}
                  </td>
                  <td class="px-4 py-3 text-sm text-right
                             {% if t.amount_due > 0 %}text-red-600{% else %}text-gray-900{% endif %}">
                    {{ t.amount_due }}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="6" class="px-4 py-6 text-center text-sm text-gray-500">
                    No payments recorded yet. Use the “Record Payment” button above to add one.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <!-- No tuition_desc: no payments -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6">
          <h2 class="text-lg leading-6 font-medium text-gray-900 mb-2">
            Payments
          </h2>
          <p class="text-sm text-gray-500">
            Payments will appear here after you set the tuition description and start recording fee transactions.
          </p>
        </div>
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}
